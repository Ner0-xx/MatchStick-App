<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matchstick Motion - Turn Photos & Videos into Glowing Stick Figures</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .upload-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .file-input {
            display: none;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .color-picker-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="color"] {
            width: 60px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }

        .color-label {
            padding: 8px 15px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 0.9em;
            flex: 1;
        }

        input[type="range"] {
            width: 100%;
        }

        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .panel h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3em;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas, video, img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        .placeholder {
            color: #999;
            text-align: center;
            padding: 40px;
        }

        .export-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .export-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-message {
            margin-top: 15px;
            color: #666;
            font-size: 0.95em;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .panels {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üï∫ Matchstick Motion</h1>
            <p class="subtitle">Transform your photos and videos into glowing stick figures!</p>
        </header>

        <div class="controls">
            <div class="upload-section">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    üìÅ Upload Photo or Video
                </button>
                <input type="file" id="fileInput" class="file-input" accept="image/*,video/*">
                <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                    Supports JPG, PNG, MP4, WebM ‚Ä¢ Max video length: 60 seconds
                </p>
            </div>

            <div id="videoWarning" class="warning hidden">
                ‚ö†Ô∏è Your video is longer than 60 seconds. Processing may be slow. Consider trimming it for better performance.
            </div>

            <div class="settings-grid">
                <div class="setting-group">
                    <label>Stick Figure Glow Color</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="glowColor" value="#00ff88">
                        <span class="color-label" id="glowColorLabel">#00ff88</span>
                    </div>
                </div>

                <div class="setting-group">
                    <label>Background Color</label>
                    <div class="color-picker-wrapper">
                        <input type="color" id="bgColor" value="#1a1a2e">
                        <span class="color-label" id="bgColorLabel">#1a1a2e</span>
                    </div>
                </div>

                <div class="setting-group">
                    <label>Glow Intensity: <span id="glowValue">20</span>px</label>
                    <input type="range" id="glowIntensity" min="5" max="40" value="20">
                </div>

                <div class="setting-group">
                    <label>Line Thickness: <span id="thicknessValue">4</span>px</label>
                    <input type="range" id="lineThickness" min="2" max="10" value="4">
                </div>
            </div>
        </div>

        <div class="panels">
            <div class="panel">
                <h2>üì∑ Original</h2>
                <div class="canvas-container" id="originalContainer">
                    <div class="placeholder">
                        <p>Upload a photo or video to get started!</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Best results with clear, full-body shots</p>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>‚ú® Matchstick Figure</h2>
                <div class="canvas-container" id="outputContainer">
                    <canvas id="outputCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="export-section">
            <h2 style="margin-bottom: 20px;">Export Your Creation</h2>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <p class="status-message" id="statusMessage">Processing...</p>
            </div>

            <div>
                <button class="export-btn" id="exportImageBtn" disabled>
                    üì∏ Download as Image
                </button>
                <button class="export-btn" id="exportVideoBtn" disabled>
                    üé• Download as Video
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let pose = null;
        let currentMedia = null;
        let mediaType = null;
        let isProcessing = false;
        let videoFrames = [];
        let currentFrame = 0;
        let animationId = null;

        // Canvas and context
        const outputCanvas = document.getElementById('outputCanvas');
        const ctx = outputCanvas.getContext('2d');

        // Settings
        let settings = {
            glowColor: '#00ff88',
            bgColor: '#1a1a2e',
            glowIntensity: 20,
            lineThickness: 4
        };

        // Initialize MediaPipe Pose
        async function initPose() {
            pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });

            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                smoothSegmentation: false,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            pose.onResults(onPoseResults);
        }

        // Handle pose detection results
        function onPoseResults(results) {
            if (!results.poseLandmarks) return;

            // Set canvas size to match source
            outputCanvas.width = results.image.width;
            outputCanvas.height = results.image.height;

            // Clear and fill background
            ctx.fillStyle = settings.bgColor;
            ctx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);

            // Draw the glowing stick figure
            drawGlowingStickFigure(results.poseLandmarks);
        }

        // Draw glowing stick figure
        function drawGlowingStickFigure(landmarks) {
            const w = outputCanvas.width;
            const h = outputCanvas.height;

            // Define connections between body points
            const connections = [
                [11, 12], // shoulders
                [11, 13], [13, 15], // left arm
                [12, 14], [14, 16], // right arm
                [11, 23], [12, 24], // torso
                [23, 24], // hips
                [23, 25], [25, 27], // left leg
                [24, 26], [26, 28], // right leg
                [0, 1], [1, 2], [2, 3], [3, 7], // face (optional)
                [0, 4], [4, 5], [5, 6], [6, 8]  // face (optional)
            ];

            // Setup glow effect
            ctx.shadowBlur = settings.glowIntensity;
            ctx.shadowColor = settings.glowColor;
            ctx.strokeStyle = settings.glowColor;
            ctx.lineWidth = settings.lineThickness;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Draw connections
            connections.forEach(([start, end]) => {
                if (landmarks[start] && landmarks[end]) {
                    const startPoint = landmarks[start];
                    const endPoint = landmarks[end];

                    // Skip if visibility is too low
                    if (startPoint.visibility < 0.5 || endPoint.visibility < 0.5) return;

                    ctx.beginPath();
                    ctx.moveTo(startPoint.x * w, startPoint.y * h);
                    ctx.lineTo(endPoint.x * w, endPoint.y * h);
                    ctx.stroke();
                }
            });

            // Draw joints as circles
            ctx.fillStyle = settings.glowColor;
            landmarks.forEach((landmark, index) => {
                // Only draw main body joints
                if (index >= 11 && landmark.visibility > 0.5) {
                    ctx.beginPath();
                    ctx.arc(landmark.x * w, landmark.y * h, settings.lineThickness * 1.5, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });

            // Reset shadow for clean rendering
            ctx.shadowBlur = 0;
        }

        // Handle file upload
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Clear previous media
            clearMedia();

            // Check file type
            if (file.type.startsWith('image/')) {
                await handleImage(file);
            } else if (file.type.startsWith('video/')) {
                await handleVideo(file);
            }
        });

        // Handle image upload
        async function handleImage(file) {
            mediaType = 'image';
            const img = new Image();
            const url = URL.createObjectURL(file);

            img.onload = async () => {
                // Display original
                const originalContainer = document.getElementById('originalContainer');
                originalContainer.innerHTML = '';
                originalContainer.appendChild(img);

                currentMedia = img;

                // Process image
                if (!pose) await initPose();
                await pose.send({image: img});

                // Enable export buttons
                document.getElementById('exportImageBtn').disabled = false;
                document.getElementById('exportVideoBtn').disabled = true;

                URL.revokeObjectURL(url);
            };

            img.src = url;
        }

        // Handle video upload
        async function handleVideo(file) {
            mediaType = 'video';
            const video = document.createElement('video');
            const url = URL.createObjectURL(file);

            video.onloadedmetadata = async () => {
                // Check duration
                if (video.duration > 60) {
                    document.getElementById('videoWarning').classList.remove('hidden');
                } else {
                    document.getElementById('videoWarning').classList.add('hidden');
                }

                // Display original
                const originalContainer = document.getElementById('originalContainer');
                originalContainer.innerHTML = '';
                video.controls = true;
                video.loop = true;
                originalContainer.appendChild(video);

                currentMedia = video;

                // Initialize pose detector
                if (!pose) await initPose();

                // Process video frames
                await processVideoFrames(video);

                URL.revokeObjectURL(url);
            };

            video.src = url;
        }

        // Process video frame by frame
        async function processVideoFrames(video) {
            videoFrames = [];
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const statusMessage = document.getElementById('statusMessage');

            progressContainer.style.display = 'block';
            isProcessing = true;

            // Create temporary canvas for frame capture
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            video.currentTime = 0;
            await new Promise(resolve => {
                video.onseeked = resolve;
            });

            tempCanvas.width = video.videoWidth;
            tempCanvas.height = video.videoHeight;
            outputCanvas.width = video.videoWidth;
            outputCanvas.height = video.videoHeight;

            const fps = 30;
            const frameDuration = 1 / fps;
            const totalFrames = Math.floor(video.duration * fps);

            statusMessage.textContent = `Processing frames... 0/${totalFrames}`;

            for (let i = 0; i < totalFrames; i++) {
                video.currentTime = i * frameDuration;
                
                await new Promise(resolve => {
                    video.onseeked = resolve;
                });

                // Draw current frame to temp canvas
                tempCtx.drawImage(video, 0, 0);

                // Process with pose detection
                await pose.send({image: tempCanvas});

                // Save the processed frame
                const frameData = outputCanvas.toDataURL('image/png');
                videoFrames.push(frameData);

                // Update progress
                const progress = Math.round(((i + 1) / totalFrames) * 100);
                progressFill.style.width = `${progress}%`;
                progressFill.textContent = `${progress}%`;
                statusMessage.textContent = `Processing frames... ${i + 1}/${totalFrames}`;
            }

            isProcessing = false;
            progressContainer.style.display = 'none';
            statusMessage.textContent = 'Video processed! Ready to export.';

            // Enable export buttons
            document.getElementById('exportImageBtn').disabled = false;
            document.getElementById('exportVideoBtn').disabled = false;

            // Start playback
            playProcessedVideo();

            // Sync with original video
            video.addEventListener('play', playProcessedVideo);
            video.addEventListener('pause', pauseProcessedVideo);
            video.addEventListener('seeked', () => {
                const frameIndex = Math.floor(video.currentTime * fps);
                showFrame(frameIndex);
            });
        }

        // Play processed video
        function playProcessedVideo() {
            if (animationId) cancelAnimationFrame(animationId);
            
            const fps = 30;
            const frameDuration = 1000 / fps;
            let lastFrameTime = Date.now();

            function animate() {
                const now = Date.now();
                const elapsed = now - lastFrameTime;

                if (elapsed >= frameDuration) {
                    currentFrame = (currentFrame + 1) % videoFrames.length;
                    showFrame(currentFrame);
                    lastFrameTime = now;
                }

                animationId = requestAnimationFrame(animate);
            }

            animate();
        }

        // Pause processed video
        function pauseProcessedVideo() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }

        // Show specific frame
        function showFrame(index) {
            if (videoFrames[index]) {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = videoFrames[index];
            }
        }

        // Export as image
        document.getElementById('exportImageBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `matchstick-${Date.now()}.png`;
            link.href = outputCanvas.toDataURL('image/png');
            link.click();
        });

        // Export as video
        document.getElementById('exportVideoBtn').addEventListener('click', async () => {
            if (videoFrames.length === 0) return;

            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const statusMessage = document.getElementById('statusMessage');

            progressContainer.style.display = 'block';
            statusMessage.textContent = 'Creating video file...';

            // Create video from frames using MediaRecorder
            const stream = outputCanvas.captureStream(30);
            const mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 5000000
            });

            const chunks = [];
            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `matchstick-${Date.now()}.webm`;
                link.click();
                URL.revokeObjectURL(url);

                progressContainer.style.display = 'none';
                statusMessage.textContent = 'Video exported successfully!';
            };

            mediaRecorder.start();

            // Play through all frames
            for (let i = 0; i < videoFrames.length; i++) {
                showFrame(i);
                await new Promise(resolve => setTimeout(resolve, 1000 / 30));
                
                const progress = Math.round(((i + 1) / videoFrames.length) * 100);
                progressFill.style.width = `${progress}%`;
                progressFill.textContent = `${progress}%`;
            }

            mediaRecorder.stop();
        });

        // Clear media
        function clearMedia() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            videoFrames = [];
            currentFrame = 0;
            currentMedia = null;
            
            document.getElementById('exportImageBtn').disabled = true;
            document.getElementById('exportVideoBtn').disabled = true;
            document.getElementById('videoWarning').classList.add('hidden');
        }

        // Update settings
        document.getElementById('glowColor').addEventListener('input', (e) => {
            settings.glowColor = e.target.value;
            document.getElementById('glowColorLabel').textContent = e.target.value;
            if (currentMedia && mediaType === 'image') {
                pose.send({image: currentMedia});
            }
        });

        document.getElementById('bgColor').addEventListener('input', (e) => {
            settings.bgColor = e.target.value;
            document.getElementById('bgColorLabel').textContent = e.target.value;
            if (currentMedia && mediaType === 'image') {
                pose.send({image: currentMedia});
            }
        });

        document.getElementById('glowIntensity').addEventListener('input', (e) => {
            settings.glowIntensity = parseInt(e.target.value);
            document.getElementById('glowValue').textContent = e.target.value;
            if (currentMedia && mediaType === 'image') {
                pose.send({image: currentMedia});
            }
        });

        document.getElementById('lineThickness').addEventListener('input', (e) => {
            settings.lineThickness = parseInt(e.target.value);
            document.getElementById('thicknessValue').textContent = e.target.value;
            if (currentMedia && mediaType === 'image') {
                pose.send({image: currentMedia});
            }
        });

        // Initialize on load
        window.addEventListener('load', () => {
            initPose();
        });
    </script>
</body>
</html>
